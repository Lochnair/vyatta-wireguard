tag:
type: txt
help: Peer public key

val_help: Base64 encoded public key

syntax:expression: pattern $VAR(@) "^[0-9a-zA-Z\+/]{43}=$" ;
	"Key is not valid 44-character (32-bytes) base64"

commit:expression: exec "${vyatta_sbindir}/vyatta-check-allowed-ips.pl --intf $VAR(../@) --peer $VAR(@)"

end:
        if [ "$COMMIT_ACTION" = DELETE ] || [ -n "$VAR(./disable)" ]; then
          if [[ $(sudo wg show "$VAR(../@)" peers) == *"$VAR(@)"* ]]; then
            sudo wg set $VAR(../@) peer "$VAR(@)" remove
          fi
        else
          sudo wg set $VAR(../@) peer $VAR(@)

          ALLOWED=$(echo "$VAR(./allowed-ips/@)" | tr ' ' ',' | tr -d "'")
          sudo wg set $VAR(../@) peer $VAR(@) allowed-ips "$ALLOWED"

          if [ -n "$VAR(./endpoint)" ]; then
            sudo wg set $VAR(../@) peer $VAR(@) endpoint "$VAR(./endpoint/@)"
          fi

          if [ -n "$VAR(../persistent-keepalive)" ]; then
            sudo wg set $VAR(../@) peer $VAR(@) persistent-keepalive $VAR(./persistent-keepalive/@)
          else
            sudo wg set $VAR(../@) peer $VAR(@) persistent-keepalive 0
          fi

          if [ -n "$VAR(./preshared-key)" ]; then
            echo "$VAR(./preshared-key/@)" | sudo bash -c 'read -r key; if [[ $key =~ ^[0-9a-zA-Z/+]{43}=$ ]]; then exec {FD}<<< $(echo "$key"); wg set $VAR(../@) peer $VAR(@) preshared-key /proc/self/fd/$FD; else wg set $VAR(../@) peer $VAR(@) preshared-key "$key"; fi'
          else
            sudo wg set $VAR(../@) peer $VAR(@) preshared-key /dev/null
          fi
        fi
